(()=>{"use strict";var t={n:e=>{var i=e&&e.__esModule?()=>e.default:()=>e;return t.d(i,{a:i}),i},d:(e,i)=>{for(var s in i)t.o(i,s)&&!t.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:i[s]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)};const e=FCEUX;var i=t.n(e);class s{constructor(t,e){this._keyHandler=this.handleKey.bind(this),this._mouseHandler=this.handleMouse.bind(this),this._inputState=new Set,this._prevInputState=new Set,this._turboFrame=!1,this._keySet=new Set,this._inputMap={},this._listenerOptions={capture:!0},this._canvas=t,this._fceux=e,this.loadOrResetInputMap(!1),window.addEventListener("keyup",this._keyHandler,this._listenerOptions),window.addEventListener("keydown",this._keyHandler,this._listenerOptions),this._canvas.addEventListener("mousedown",this._mouseHandler,this._listenerOptions)}loadOrResetInputMap(t){const e=localStorage["input-map"];t||void 0===e?(this._inputMap=s.defaultInputMap(),this.saveInputMap()):this._inputMap=JSON.parse(e)}saveInputMap(){localStorage["input-map"]=JSON.stringify(this._inputMap)}dispose(){this.saveInputMap(),this._canvas.removeEventListener("mousedown",this._mouseHandler,this._listenerOptions),window.removeEventListener("keydown",this._keyHandler,this._listenerOptions),window.removeEventListener("keyup",this._keyHandler,this._listenerOptions)}update(){this._turboFrame=!this._turboFrame;const t=this._prevInputState;this._prevInputState=this._inputState,this._inputState=t,this._inputState.clear();const e=navigator&&navigator.getGamepads?navigator.getGamepads():[];for(let t in this._inputMap){const i=this._inputMap[t];(this.isInputKeysActive(i[0])||this.isInputGamepadActive(e,i[1]))&&this._inputState.add(t)}return this.updateSystem(),this.updateControllers()}setInput(t,e,i){this._inputMap[t]=[e,i],this.saveInputMap()}static idToName(t){return s._defaultInputSpec[t][0]}isInputKeysActive(t){if(t.length>0){for(let e of t)if(!this._keySet.has(e))return!1;return!0}return!1}isInputGamepadActive(t,e){const i=3&e;if(i&&t){const s=(12&e)>>2;if(s<t.length){const n=t[s];if(n&&n.connected){const t=(240&e)>>4;switch(i){case 1:return t<n.buttons.length&&(n.buttons[t].pressed||n.buttons[t].value>=.1);case 2:return t<n.axes.length&&n.axes[t]<=-.1;case 3:return t<n.axes.length&&n.axes[t]>=.1}}}}return!1}static defaultInputSpec(){const t={reset:["Reset",["KeyR","ControlLeft"],0],throttle:["Throttle",["Tab"],0],pause:["Pause",["KeyP"],0],advanceFrame:["Advance Single Frame",["Slash"],0],stateSave:["Save State",["F5"],0],stateLoad:["Load State",["F7"],0],state0:["Select State 0",["Digit0"],0],state1:["Select State 1",["Digit1"],0],state2:["Select State 2",["Digit2"],0],state3:["Select State 3",["Digit3"],0],state4:["Select State 4",["Digit4"],0],state5:["Select State 5",["Digit5"],0],state6:["Select State 6",["Digit6"],0],state7:["Select State 7",["Digit7"],0],state8:["Select State 8",["Digit8"],0],state9:["Select State 9",["Digit9"],0]},e={A:["A",["KeyF"],1],B:["B",["KeyD"],17],Select:["Select",["KeyS"],161],Start:["Start",["Enter"],177],Up:["Up",["ArrowUp"],18],Down:["Down",["ArrowDown"],19],Left:["Left",["ArrowLeft"],2],Right:["Right",["ArrowRight"],3],TurboA:["Turbo A",["KeyH"],49],TurboB:["Turbo B",["KeyG"],65]};for(let i of["1","2","3","4"]){const s="controller"+i,n=" (Controller "+i+")";for(let a in e){const o=e[a],r="1"!=i?[]:o[1],l="1"!=i?0:o[2];t[s+a]=[o[0]+n,r,l]}}return t}static defaultInputMap(){const t={};for(let e in s._defaultInputSpec){const i=s._defaultInputSpec[e];t[e]=[i[1],i[2]]}return t}updateSystem(){const t=this._fceux;this.inputPressed("reset")&&t.reset(),this.inputPressed("pause")&&t.setPaused(!t.paused()),this.inputPressed("advanceFrame")&&t.advanceFrame(),this.inputPressed("stateSave")&&t.saveState(),this.inputPressed("stateLoad")&&t.loadState();for(let e=0;e<10;++e)this.inputPressed("state"+e)&&t.setState(e);t.setThrottling(this.inputDown("throttle"))}updateControllers(){return this.bitsForController("2")<<8|this.bitsForController("1")}bitsForController(t){let e=0;const i="controller"+t;return this.inputDown(i+"A")&&(e|=1),this.inputDown(i+"B")&&(e|=2),this.inputDown(i+"Select")&&(e|=4),this.inputDown(i+"Start")&&(e|=8),this.inputDown(i+"Up")&&(e|=16),this.inputDown(i+"Down")&&(e|=32),this.inputDown(i+"Left")&&(e|=64),this.inputDown(i+"Right")&&(e|=128),this._turboFrame&&(this.inputDown(i+"TurboA")&&(e|=1),this.inputDown(i+"TurboB")&&(e|=2)),48==(48&e)&&(e&=-33),192==(192&e)&&(e&=-129),e}inputDown(t){return this._inputState.has(t)}inputPressed(t){return!this._prevInputState.has(t)&&this._inputState.has(t)}handleKey(t){t.metaKey||t.altKey?this._keySet.clear():("keydown"==t.type?this._keySet.add(t.code):this._keySet.delete(t.code),t.preventDefault())}handleMouse(t){const e=this._canvas.getBoundingClientRect();this._fceux.triggerZapper(t.clientX-e.left,t.clientY-e.top)}}s._defaultInputSpec=s.defaultInputSpec();class n{constructor(t,e){this._catchId="",this._catchKeys=[],this._catchGamepad=0,this._keyDownListener=this.handleKeyDown.bind(this),this._gamepadInterval=0,this._listenerOptions={capture:!1,passive:!0},this._el=t,this._input=e,this.reset()}dispose(){this.removeListeners()}handleKeyDown(){const t=Array.from(this._input._keySet);this._el.catchKey.innerHTML=n.formatKeys(t),this._catchKeys=t}isShown(){return"block"==this._el.keyBindDiv.style.display}show(t){this.isCatching()||(this._el.keyBindDiv.style.display=t?"block":"none")}toggleShow(){this.show(!this.isShown())}clearBinding(t){const e=t.dataset.id;this._input.setInput(e,[],0),this.reset()}resetToDefaults(){this._input.loadOrResetInputMap(!0),this.reset()}catchStart(t){const e=t.dataset.id;this._catchId=e,this._el.catchName.innerHTML=t.dataset.name;const i=this._input._inputMap[e];this._catchKeys=i[0],this._el.catchKey.innerHTML=n.formatKeys(i[0]),this._catchGamepad=i[1],this._el.catchGamepad.innerHTML=n.formatGamepad(i[1]),this._el.catchDiv.style.display="block",this.addListeners()}catchEnd(t){if(t&&this._catchId){for(let t in this._input._inputMap){if(t==this._catchId)continue;const e=this._input._inputMap[t];if(e[0]&&this._catchKeys==e[0]){if(!confirm("Key "+n.formatKeys(e[0])+" already bound to "+t+". Clear the previous binding?"))return;this._input.setInput(t,[],e[1])}if(e[1]&&this._catchGamepad==e[1]){if(!confirm(n.formatGamepad(e[1])+" already bound to "+t+". Clear the previous binding?"))return;this._input.setInput(t,e[0],0)}}this._input.setInput(this._catchId,this._catchKeys,this._catchGamepad),this._catchId="",this.reset()}this.removeListeners(),this._el.catchDiv.style.display="none"}isCatching(){return"block"==this._el.catchDiv.style.display}addListeners(){document.addEventListener("keydown",this._keyDownListener,this._listenerOptions),this._gamepadInterval=window.setInterval((()=>{const t=this.scanForGamepadBinding();t&&(this._el.catchGamepad.innerHTML=n.formatGamepad(t),this._catchGamepad=t)}),60)}removeListeners(){clearInterval(this._gamepadInterval),document.removeEventListener("keydown",this._keyDownListener,this._listenerOptions)}scanForGamepadBinding(){if(navigator&&navigator.getGamepads){const t=navigator.getGamepads();let e=t.length-1;for(e>3&&(e=3);e>=0;--e){const i=t[e];if(i&&i.connected){let t=i.buttons.length-1;for(t>15&&(t=15);t>=0;--t){const s=i.buttons[t];if(s.pressed||s.value>=.1)return t<<4|e<<2|1}for(t=i.axes.length-1,t>15&&(t=15);t>=0;--t){const s=i.axes[t];if(s<=-.1)return t<<4|e<<2|2;if(s>=.1)return t<<4|e<<2|3}}}}return 0}static fixKey(t){for(let e of["Key","Digit","Arrow"])if(t.startsWith(e))return t.slice(e.length);return t}static formatKeys(t){return(t=t.map((t=>n.fixKey(t))))&&t.length>0?t.join("+"):"(Unset)"}static formatGamepad(t){const e=3&t;return e?"Gamepad "+((12&t)>>2)+" "+["Button","-Axis","+Axis"][e-1]+" "+((240&t)>>4):"(Unset)"}reset(){const t=this._el.keyBindTable;for(;t.lastChild!=t.firstChild;)t.removeChild(t.lastChild);for(let e in this._input._inputMap){const i=this._input._inputMap[e],a=s.idToName(e),o=this._el.keyBindProto.cloneNode(!0);o.children[0].innerHTML=a,o.children[1].innerHTML=n.formatKeys(i[0]),o.children[2].innerHTML=n.formatGamepad(i[1]),o.children[3].dataset.id=e,o.children[3].dataset.name=a,t.appendChild(o)}}}function a(t){localStorage.games=JSON.stringify(t)}function o(){return localStorage.hasOwnProperty("games")?JSON.parse(localStorage.games):{}}class r{constructor(t,e,i){this._label=t,this._url=e,this._offset=3*(3*Math.random()|0),this._deletable=i}createDomElement(t){const e=r._proto.cloneNode(!0);0==t&&(e.classList.add("cartAdd"),this._offset=3),e.dataset.idx=t,e.style.backgroundPosition=this._offset+"px 0px";const i=e.firstChild.firstChild.firstChild;i.innerHTML=this._label,i.style.fontSize="16px",i.style.lineHeight="18px";let s=13;for(;i.scrollHeight>18&&s>=9;)i.style.fontSize=s+"px",s-=2;return i.scrollHeight>18&&(i.style.lineHeight="9px"),this._deletable||(e.firstChild.lastChild.hidden=!0),e}start(t){if(this._deletable){const e=o();t.loadGame(new Uint8Array(e[this._url]),this._url.split("/").pop())}else t.downloadGame(this._url)}}r._proto=document.getElementById("cartProto");class l{constructor(){this._carts=[],this._div=document.getElementById("stack"),this._container=document.getElementById("stackContainer"),this._toggle=document.getElementById("stackToggle")}show(t){this._toggle.checked=void 0===t?!this._toggle.checked:t}getCart(t){return this._carts[t]}addCart(t,e){!function(t,e){const i=o();i[t]=Array.from(e),a(i)}(t,e),this.update()}removeCart(t){!function(t){const e=o();delete e[t],a(e)}(this._carts[t]._url),this.update()}update(){const t=["Streemerz.nes","2048.nes","Lawn Mower.nes","Alter Ego.nes","Super Bat Puncher (Demo).nes","Lan Master.nes"];this._carts.length=0;const e=(t,e)=>{const i=function(t){const e=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/.exec(t);return e?e.slice(1):[]}(t),s=i[2].slice(0,-i[3].length).toUpperCase();this._carts.push(new r(s,t,e))};for(let i of t)e("games/"+i,!1);for(let t in o())e(t,!0);this._carts.sort(((t,e)=>t._label<e._label?-1:t._label>e._label?1:0)),this._carts.unshift(new r("","",!1)),this.updateDom()}updateDom(){const t=this._container,e=t.scrollTop,i=this._div;for(;i.firstChild!=i.lastChild;)i.removeChild(i.lastChild);for(let t=0;t<this._carts.length;++t)i.appendChild(this._carts[t].createDomElement(t));t.scrollTop=e}}class h{constructor(){this.menuContainerToggle=document.getElementById("menuContainerToggle"),this.catchDiv=document.getElementById("catchDiv"),this.catchGamepad=document.getElementById("catchGamepad"),this.catchKey=document.getElementById("catchKey"),this.catchName=document.getElementById("catchName"),this.controllersToggle=document.getElementById("controllersToggle"),this.keyBindDiv=document.getElementById("keyBindDiv"),this.keyBindProto=document.getElementById("keyBindProto"),this.keyBindTable=document.getElementById("keyBindTable"),this.fullscreenIcon=document.getElementById("fullscreenIcon"),this.soundIcon=document.getElementById("soundIcon"),this.dpadIcon=document.getElementById("dpadIcon"),this.introDiv=document.getElementById("introDiv"),this.helpToggle=document.getElementById("helpToggle"),this.selectFile=document.getElementById("selectFile")}}class c{constructor(t,e){this._el=new h,this._stack=new l,this._initialized=!1,this._gameLoadedListener=this.handleGameLoaded.bind(this),this._dropListener=this.handleDrop.bind(this),this._dragListener=t=>{t.stopPropagation(),t.preventDefault()},this._keyListener=t=>{var e,i;"Escape"==t.code&&(this._el.helpToggle.checked||(null===(e=this._inputDialog)||void 0===e?void 0:e.isShown())?(this._el.helpToggle.checked=!1,null===(i=this._inputDialog)||void 0===i||i.show(!1)):(this._stack.show(!1),this.showControls(!1),this.showMenuContainer(!0)))},this._contextLostListener=t=>{alert("WebGL context lost. You will need to reload the page."),t.preventDefault()},this._beforeUnloadListener=t=>{t.preventDefault(),t.returnValue=""},this._saveFilesInterval=0,this._fceux=t,this._canvasSelector=e,this._canvas=document.querySelector(e),this._stack.update(),this._stack.show(!0),this.initConfig(!1),document.addEventListener("keydown",this._keyListener),document.addEventListener("dragenter",this._dragListener,!1),document.addEventListener("dragleave",this._dragListener,!1),document.addEventListener("dragover",this._dragListener,!1),document.addEventListener("drop",this._dropListener,!1),this._canvas.addEventListener("webglcontextlost",this._contextLostListener,!1),window.addEventListener("beforeunload",this._beforeUnloadListener),document.body.addEventListener("mousedown",(t=>{const e=document.elementFromPoint(t.clientX,t.clientY)==this._canvas;this.showMenuContainer(!e)}))}showMenuContainer(t){this._initialized&&(this._el.menuContainerToggle.checked=!t)}init(){if(this._initialized)return;this._initialized=!0,this._fceux.init(this._canvasSelector),this.initConfig(!1),this._fceux.addEventListener("game-loaded",this._gameLoadedListener),this._saveFilesInterval=window.setInterval((()=>{const t=this._fceux.gameMd5();if(t){const e=this._fceux.exportSaveFiles(),i={};for(let t in e)i[t]=Array.from(e[t]);localStorage["save-"+t]=JSON.stringify(i)}}),1e3),this._input=new s(this._canvas,this._fceux),this._inputDialog=new n(this._el,this._input);const t=()=>{if(this._initialized){window.requestAnimationFrame(t);const e=this._input.update();this._fceux.setControllerBits(e),this._fceux.update()}};window.requestAnimationFrame(t),this._el.introDiv.style.display="none",this._el.dpadIcon.style.display="block",this._el.soundIcon.style.display="block",this._el.fullscreenIcon.style.display="block"}dispose(){var t;this._initialized&&(this._inputDialog.dispose(),null===(t=this._input)||void 0===t||t.dispose(),clearInterval(this._saveFilesInterval),this._fceux.removeEventListener(this._gameLoadedListener),this._initialized=!1),window.removeEventListener("beforeunload",this._beforeUnloadListener),this._canvas.removeEventListener("webglcontextlost",this._contextLostListener,!1),document.removeEventListener("drop",this._dropListener,!1),document.removeEventListener("dragover",this._dragListener,!1),document.removeEventListener("dragleave",this._dragListener,!1),document.removeEventListener("dragenter",this._dragListener,!1),document.removeEventListener("keydown",this._keyListener)}onClickCart(t,e){t.stopPropagation(),t.preventDefault();const i=1*e.dataset.idx;if(0==i)this._el.selectFile.click();else{const t=this._stack.getCart(i);t&&(this._initialized||this.init(),t.start(this._fceux))}return!1}onClickCartDelete(t,e){t.stopPropagation(),t.preventDefault();const i=1*e.dataset.idx,s=this._stack.getCart(i);return s&&(confirm("Are you sure you want to delete "+s._label+"?")&&this._stack.removeCart(i),this._initialized&&setTimeout((()=>{var t;return null===(t=this._fceux._audioContext)||void 0===t?void 0:t.resume()}))),!1}handleSelectFile(t){this.readFile(t[0])}handleGameLoaded(t){const e=this._fceux.gameMd5();if(e&&localStorage.hasOwnProperty("save-"+e)){const i=JSON.parse(localStorage["save-"+e]),s={};for(let e in i)e.startsWith("rom")&&(s[t.split(".").shift()+e.substring(3)]=new Uint8Array(i[e]));for(let t in i)t.startsWith("rom")||(s[t]=new Uint8Array(i[t]));this._fceux.importSaveFiles(s)}setTimeout((()=>{this._stack.show(!1),this.showControls(!1),this.showMenuContainer(!1)}),1e3)}readFile(t){if(t){const e=new FileReader;e.onload=()=>{const i=new Uint8Array(e.result);this._initialized&&this._fceux.loadGame(i,t.name),this._stack.addCart(t.name,i)},e.readAsArrayBuffer(t)}}handleDrop(t){t.stopPropagation(),t.preventDefault(),this.readFile(t.dataTransfer?t.dataTransfer.files[0]:null)}showControls(t){this._el.controllersToggle.checked=void 0===t?!this._el.controllersToggle.checked:t}storeConfig(t,e){const i=isNaN(+e)?e:+e;this._initialized&&this._fceux.setConfig(t,i),localStorage[t]=i}setConfig(t){this.storeConfig(t.id,"checkbox"==t.type?t.checked?1:0:t.value)}setControllerEl(t,e){const i=document.getElementById(t);i&&("SELECT"==i.tagName||"range"==i.type?i.value=e:"checkbox"==i.type&&(i.checked=!!e))}initConfig(t){for(let e in this._fceux._defaultConfig){let i=this._fceux._defaultConfig[e];!t&&localStorage.hasOwnProperty(e)&&(i=localStorage[e],i=isNaN(+i)?i:+i),this.storeConfig(e,i),this.setControllerEl(e,i)}}toggleFullscreen(){"requestFullscreen"in this._canvas?document.fullscreenElement?(document.exitFullscreen(),this.showMenuContainer(!0)):this._canvas.requestFullscreen().catch((t=>{console.warn("Can't enter fullscreen, "+t.message+".")})):"webkitRequestFullscreen"in this._canvas?document.webkitFullscreenElement?(document.webkitExitFullscreen(),this.showMenuContainer(!0)):this._canvas.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT):console.warn("Fullscreen API unavailable.")}toggleMuted(){this._initialized&&(this._fceux.setMuted(!this._fceux.muted()),this._el.soundIcon.style.backgroundPosition=(this._fceux.muted()?"-80":"-32")+"px -48px")}toggleInputBindings(){this._initialized&&this._inputDialog.toggleShow()}}const d={print:(...t)=>{console.log(Array.prototype.slice.call(t).join(" "))},printErr:(...t)=>{console.error(Array.prototype.slice.call(t).join(" "))}};i()(d).then((t=>{globalThis.fceux=t,globalThis.app=new c(t,"#mycanvas")}))})();